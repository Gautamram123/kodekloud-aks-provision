name: Bootstrap GitOps Repository

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to commit to (will be created/reset if missing)"
        required: false
        default: "main"
      commit_message:
        description: "Commit message"
        required: false
        default: "chore(gitops): initialize repo structure"
      git_user_name:
        description: "Git author name for the commit"
        required: false
        default: "github-actions[bot]"
      git_user_email:
        description: "Git author email for the commit"
        required: false
        default: "github-actions[bot]@users.noreply.github.com"
      add_examples:
        description: "Add example Argo CD manifests (true/false)"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git author
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "${{ github.event.inputs.git_user_name }}"
          git config user.email "${{ github.event.inputs.git_user_email }}"

      - name: Ensure target branch exists and check out
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.inputs.branch }}"
          # Create or reset local branch to current HEAD, then push upstream if missing
          git checkout -B "$BRANCH"
          # If remote doesn't have this branch yet, set upstream on first push later
          echo "Checked out branch: $BRANCH"

      - name: Create GitOps folder structure (+ .gitkeep)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p gitops/apps
          mkdir -p gitops/environments/dev
          mkdir -p gitops/environments/stage
          mkdir -p gitops/environments/prod
          mkdir -p gitops/platform/argocd
          mkdir -p gitops/platform/ingress
          mkdir -p gitops/platform/monitoring

          # Ensure empty directories are tracked
          for d in \
            gitops/apps \
            gitops/environments/dev \
            gitops/environments/stage \
            gitops/environments/prod \
            gitops/platform/argocd \
            gitops/platform/ingress \
            gitops/platform/monitoring
          do
            [ -f "$d/.gitkeep" ] || : > "$d/.gitkeep"
          done

          # Minimal README (no here-docs; keep it very small)
          if [ ! -f README.md ]; then
            printf '%s\n' "# GitOps Repository" "" \
            "\`gitops/\` contains:" \
            "- apps/: application manifests / charts / kustomize overlays" \
            "- environments/: env-specific app-of-apps (dev/stage/prod)" \
            "- platform/: cluster-wide components (argocd, ingress, monitoring)" \
            > README.md
          fi

      - name: Optionally add example Argo CD manifests (no here-docs)
        if: ${{ github.event.inputs.add_examples == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p gitops/apps/my-service
          # Example Application manifest (ANSI-C quoted string with \n)
          APP_MANIFEST=$'apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: my-service\n  namespace: argocd\nspec:\n  project: default\n  source:\n    repoURL: https://github.com/your-org/your-app-repo\n    targetRevision: main\n    path: k8s\n  destination:\n    server: https://kubernetes.default.svc\n    namespace: my-service\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n'
          printf '%s' "$APP_MANIFEST" > gitops/apps/my-service/app.yaml

          mkdir -p gitops/environments/dev
          # Example App-of-Apps with two docs separated by '---'
          APP_OF_APPS=$'apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: dev\n  namespace: argocd\nspec:\n  project: default\n  source:\n    repoURL: https://github.com/your-user/your-gitops-repo.git\n    path: gitops/environments/dev\n    targetRevision: main\n  destination:\n    server: https://kubernetes.default.svc\n    namespace: argocd\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n---\napiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: my-service-dev\n  namespace: argocd\nspec:\n  project: default\n  source:\n    repoURL: https://github.com/your-user/your-gitops-repo.git\n    path: gitops/apps/my-service\n    targetRevision: main\n  destination:\n    server: https://kubernetes.default.svc\n    namespace: my-service\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n'
          printf '%s' "$APP_OF_APPS" > gitops/environments/dev/app-of-apps.yaml

          # Platform note (small markdown created without here-docs)
          [ -f gitops/platform/argocd/README.md ] || printf '%s\n' "# Argo CD Bootstrap" "Place Argo CD install manifests/values here." > gitops/platform/argocd/README.md

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "${{ github.event.inputs.commit_message }}"

      - name: Push branch
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.inputs.branch }}"
          # Try normal push first; if upstream isnâ€™t set (new branch), set it
          if git push origin "$BRANCH"; then
            exit 0
          fi
          git push -u origin "$BRANCH"
